version: 0.2

env:
  variables:
    ECR_URI: "ECR_URI"
    AWS_REGION: "AWS_REGION"
    TF_WORKSPACE: $CODEBUILD_WEBHOOK_TRIGGER
    SSM_PARAM_DB_PASSWORD_NAME: $SSM_PARAM_DB_PASSWORD_NAME

phases:
  pre_build:
    commands:
      # Log in to ECR
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI)
      # Fetch ssm parameter store
      - export TF_VAR_db_password=$(aws ssm get-parameter --name $SSM_PARAM_DB_PASSWORD_NAME --with-decryption --query "Parameter.Value" --output text)
  
  build:
    commands:
      # Build Docker image
      - echo Building Docker image...
      - docker-compose -f docker-compose.yml build api

  post_build:
    commands:
      # Tag and push Docker image
      - echo Tagging and pushing Docker image...
      - docker tag bookyland-app:latest $ECR_URI/bookyland-app:latest
      - docker push $ECR_URI/bookyland-app:latest

      # Initialize and apply Terraform
      - echo Initializing and applying Terraform...
      - docker-compose run --rm terraform init
      - docker-compose run --rm terraform workspace select $TF_WORKSPACE || docker-compose run --rm terraform workspace new $TF_WORKSPACE
      - docker-compose run --rm terraform apply -auto-approve

      # Done
      - echo "Terraform deployment completed for environment $TF_WORKSPACE."

cache:
  paths:
    - /root/.cache/docker # Docker cache if applicable
